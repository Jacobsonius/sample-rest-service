name: update-tests

on:
  workflow_call:
    inputs:
      attempt:
        required: true
        type: number
    outputs:
      check_exit_code:
        description: "Result of the check"
        value: ${{ jobs.build.outputs.check_exit_code }}
    secrets:
      MY_SECRET_KEY:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      check_exit_code: ${{ steps.QAVar.outputs.check_exit_code }}

    steps:
      - name: 🧾 Checkout project
        uses: actions/checkout@v4

      - name: ☕ Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 📥 Download artefact
        uses: actions/download-artifact@v4
        with:
          name: qa-artefacts
          path: ./qa-artefacts

      - name: 🧠 Generating plan
        id: QAPlan
        uses: Jacobsonius/qa-assistance-action@master
        with:
          key: ${{ secrets.MY_SECRET_KEY }}
          action-name: PLAN_UPDATE
          attempt: ${{ inputs.attempt }}
          artefacts-dir: ./qa-artefacts
          input-dir: .
          output-dir: .

      - name: 🧠 Updating tests
        id: QATests
        uses: Jacobsonius/qa-assistance-action@master
        with:
          key: ${{ secrets.MY_SECRET_KEY }}
          action-name: JUNIT
          attempt: ${{ inputs.attempt }}
          artefacts-dir: ./qa-artefacts
          input-dir: .
          output-dir: .

      - name: ⚙️Build and re-test (Attempt ${{ inputs.attempt }})
        continue-on-error: true # mvn  clean verify -DskipTests -q -B
        run: |
          mvn clean verify | tee build.log 

      - name: 🧠 Check target goal
        id: QACheck
        continue-on-error: true
        uses: Jacobsonius/qa-assistance-action@master
        with:
          key: ${{ secrets.MY_SECRET_KEY }}
          action-name: CHECK_TESTS
          target-value: '0.7'
          attempt: ${{ inputs.attempt }}
          artefacts-dir: ./qa-artefacts
          build-report-dir: .
          input-dir: .
          output-dir: .

      - name: 🔧 Make output variable
        id: QAVar
        run: |
          if [[ -f "./exit_code.txt" ]]; then
            value=$(cat "./exit_code.txt")
          else
            value=1
          fi
          echo "check_exit_code=$value" >> "$GITHUB_OUTPUT"


      - name: 📁 Prepare artefacts directory
        run: |
          cp ./target/site/jacoco/index.html qa-artefacts/jacoco.html || true
          cp ./target/surefire-reports/*.xml qa-artefacts/ || true
          cp -r build.log qa-artefacts/ || true
          cp -r .plan qa-artefacts/ || true
          cp -r .tests qa-artefacts/ || true


      - name: 💾 Save artefact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-artefacts
          overwrite: true
          include-hidden-files: true
          path: qa-artefacts/

      - name: 🧹 Remove tmp files
        run: |
          rm -f .plan
          rm -f .tests
          rm -f exit_code.txt
          rm -f build.log
          rm -f loadtest.log
          rm -rf qa-artefacts


      - name: ❌ Force fail if third attempt fails
        run: |
          if [[ "${{ steps.QAVar.outputs.check_exit_code }}" != "0" && "${{ inputs.attempt }}" == "4" ]]; then
            echo "❌ Job is being forcefully failed due to 3rd failed attempt"
            exit 1
          fi


      - name: 🔀 Create Pull Request
        if: steps.QAVar.outputs.check_exit_code == '0'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "QA Assistance: JUnit tests updated"
          branch: auto/update-report
          title: "QA Assistance"
          body: "This PR was automatically created from QA Assistance"
          base: qa