name: Java CI with Maven

on:
  push:
    branches: [ "qa" ]

jobs:

  create-llm-index:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout project
        uses: actions/checkout@v4

      - name: â˜• Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: âš™ï¸Build and test
        continue-on-error: false
        run: mvn clean verify

      - name: ğŸ§  Generate LLM index
        id: QAIndex
        uses: Jacobsonius/qa-assistance-action@master
        with:
          key: ${{ secrets.KEY }}
          action-name: INDEX
          target-value: '80'
          build-report-dir: ./
          test-report-dir: ./target/surefire-reports
          coverage-report-dir: ./target/site/jacoco
          input-dir: ./
          output-dir: ./

      - name: ğŸ’¾ Save artefact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-artefacts
          overwrite: true
          include-hidden-files: true
          path: |
            .qa
            ./target/site/jacoco/index.html
            ./target/surefire-reports/*.xml

  update-tests:
    needs: create-llm-index
    if: needs.create-llm-index.result == 'success'
    uses: ./.github/workflows/reusable.yml
    with:
      attempt: 1
    secrets:
      MY_SECRET_KEY: ${{ secrets.KEY }}

#  update-tests-retry-1:
#    needs: update-tests
#    if: needs.update-tests.result == 'failure' || needs.update-tests.outputs.build_exit_code != '0'
#    uses: ./.github/workflows/reusable.yml
#    with:
#      attempt: 2
#    secrets:
#      MY_SECRET_KEY: ${{ secrets.KEY }}
#
#  update-tests-retry-2:
#    needs: update-tests-retry-1
#    if: needs.update-tests-retry-1.result == 'failure' || needs.update-tests-retry-1.outputs.build_exit_code != '0'
#    uses: ./.github/workflows/reusable.yml
#    with:
#      attempt: 3
#    secrets:
#      MY_SECRET_KEY: ${{ secrets.KEY }}