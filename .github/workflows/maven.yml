name: Java CI with Maven

on:
  push:
    branches: [ "qa" ]
  pull_request:
    branches: [ "master" ]

jobs:

  create-llm-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build and test with Maven
        continue-on-error: false
        run: mvn clean verify

      - name: Save test report
        if: always()  # even if the tests failed
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: target/surefire-reports/*.xml
          overwrite: true

      - name: Save coverage report
        if: always()  # even if the tests failed
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/index.html
          overwrite: true

#      - name: Log in to Docker Hub
#        uses: docker/login-action@v3
#        with:
#          username: ${{ env.DOCKER_USERNAME }}
#          password: ${{ env.DOCKER_PASSWORD }}
      -
      - name: Generating project llm index
        id: QAIndex
        uses: Jacobsonius/hello-world-docker-action@DockerHub
        with:
          key: ${{ secrets.KEY }}
          action-name: INDEX
          target-value: '80'
          test-report-dir: ./target
          coverage-report-dir: ./target
          input-dir: ./
          output-dir: ./

      - name: Save Index
        uses: actions/upload-artifact@v4
        with:
          name: llm-index
          include-hidden-files: true
          path: .qa
          overwrite: true

  update-tests:
    needs: create-llm-index
    if: needs.create-llm-index.result == 'success'
    uses: ./.github/workflows/reusable.yml
    with:
      attempt: 1
    secrets:
      MY_SECRET_KEY: ${{ secrets.KEY }}

  update-tests-retry-1:
    needs: update-tests
    if: needs.update-tests.result == 'failure' || needs.update-tests.outputs.build_exit_code != '0'
    uses: ./.github/workflows/reusable.yml
    with:
      attempt: 2
    secrets:
      MY_SECRET_KEY: ${{ secrets.KEY }}

  update-tests-retry-2:
    needs: update-tests-retry-1
    if: needs.update-tests-retry-1.result == 'failure' || needs.update-tests-retry-1.outputs.build_exit_code != '0'
    uses: ./.github/workflows/reusable.yml
    with:
      attempt: 3
    secrets:
      MY_SECRET_KEY: ${{ secrets.KEY }}